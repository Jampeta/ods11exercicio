"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[9308],{47602:(e,t,r)=>{r.r(t),r.d(t,{default:()=>h});r(67294);var o=r(480),n=r(86628),u=r(47025),i=r(14714),l=r(9291),s=(r(21703),r(57658),r(30120)),c=r(21202),a=r(26842),d=r(37034);const p="grouped_chart_results";function f(e){let{xAxisGroupBy:t,groupResults:r,aggregationResults:o,collectionStore:n,environment:l,intl:p}=e;const{type:f}=t;if(!(0,u.mk)(f))return;const g=[];return r.forEach((e=>{const r=e.value,u=(0,i.Hd)(r),s=o[u];if(!s)throw new Error(`Could not find aggregation for the chart group ${u}`);const f=function(e){let{groupBy:t,groupValue:r,collectionStore:o,environment:n,intl:u}=e;if((0,i.tL)(r)){const e=r.value;if((0,i.RA)(e)){const t=e.id,r=a.G.createChildStore(o,{id:t,table:c.iU});return(0,d.vU)({environment:n,intl:u,store:r})}if((0,i.t2)(e))return e.value.variable;if(!e){const e=o.getSchema()[t.property];return`No ${null==e?void 0:e.name}`}}else if((0,i.Mc)(r)){var l,s,p,f;if("day"===(null===(l=r.value)||void 0===l?void 0:l.type)||"month"===(null===(s=r.value)||void 0===s?void 0:s.type)||"week"===(null===(p=r.value)||void 0===p?void 0:p.type)||"year"===(null===(f=r.value)||void 0===f?void 0:f.type))return r.value.range.start_date}}({groupBy:t,groupValue:r,collectionStore:n,environment:l,intl:p}),v=function(e){const t=e.aggregationResult;if("number"===t.type)return t.value}(s);if(f&&v){const e={ds:f,values:{value:v}};g.push(e)}})),(0,i.ib)(t)&&(0,i.A1)(f)?function(e){let{xAxisType:t,groupBy:r,initialDataPoints:o}=e;if(!(0,i.A1)(t)||"relative"===r)return;const n=function(e){return`${e}s`}(r),u=[];for(let i=0;i<o.length;i++){const e=o[i];if(u.push(e),i===o.length-1)break;const t=o[i].ds,r=o[i+1].ds,l=s.ou.fromISO(t),c=(s.ou.fromISO(r).diff(l,n).toObject()[n]||0)-1;if(c<=0)continue;let a=l;for(let o=0;o<c;o++){const e=a.plus({[n]:1}),t={ds:e.toISODate(),values:{value:0}};u.push(t),a=e}}return{xAxisType:t,dataPoints:u}}({xAxisType:f,groupBy:t.groupBy,initialDataPoints:g}):{xAxisType:f,dataPoints:g}}var g=r(48190),v=r(85893);function y(e){let{collectionContextStore:t,groupedChartReducer:r,chartConfig:u}=e;window.__c={n:"GroupedAxisChart"};const i=(0,o.O7)(),s=(0,l.useIntl)(),c=(0,n.VK)((()=>t.collectionStore()),[t]),a=(0,g.Z)({id:p,reducer:r,collectionContextStore:t}),d=(0,n.VK)((()=>{if(!a||!c)return;const e=a.results,t=a.aggregationResults;if(!t)return;return f({xAxisGroupBy:u.dataConfig.xAxis.groupBy,groupResults:e,aggregationResults:t,collectionStore:c,environment:i,intl:s})}),[a,u,c,i,s],{useDeepEqual:!0});return d?(0,v.jsxs)("div",{style:{paddingLeft:120,paddingTop:20},children:["Data points: ",JSON.stringify(d.dataPoints)]}):null}const h=function(e){let{collectionContextStore:t,format:r,schema:o}=e;window.__c={n:"CollectionChartView"};const l=(0,n.VK)((()=>t.collectionStore()),[t]),{chartConfig:s,error:c}=(0,n.VK)((()=>(0,u.Fs)({collectionPointer:null==l?void 0:l.pointer,chartConfig:r.chart_config,collectionSchema:o})),[r,o,l]),a=(0,n.VK)((()=>{if("axis"!==(null==s?void 0:s.type))return;const{groupBy:e}=s.dataConfig.xAxis,{property:t}=e,r=o[t];if(r&&(0,i.LG)(r)&&(0,u.mk)(r.type)){const t=function(e){if("axis"===e.type){return"record_count"===e.dataConfig.series[0].type?"count":void 0}return}(s);if(!t)return;return{type:"groups",limit:1e3,groupBy:e,groupSortPreference:[],aggregation:{aggregator:t}}}}),[s,o],{useDeepEqual:!0});return c?(0,v.jsxs)("div",{style:{paddingLeft:120,paddingTop:20},children:["Error: ",c.type]}):(0,v.jsx)(v.Fragment,{children:a&&"axis"===(null==s?void 0:s.type)&&(0,v.jsx)(y,{chartConfig:s,collectionContextStore:t,groupedChartReducer:a})})}},48190:(e,t,r)=>{r.d(t,{P:()=>d,Z:()=>a});var o=r(67294),n=r(1302),u=r(86628),i=r(28155),l=r(40107),s=r(72126),c=r(75330);function a(e){const{id:t,reducer:r,collectionContextStore:i,groupsPointer:a}=e,p=(0,u.VK)((()=>a),[a],{useDeepEqual:!0}),f=(0,u.VK)((()=>r),[r],{useDeepEqual:!0}),g=(0,u.VK)((()=>i.collectionViewStore()),[i]),v=(0,o.useRef)(!1),y=(0,l.S)(),[h,x]=(0,o.useReducer)(((e,t)=>s.Xy(e,t)?e:t),void 0),R=(0,o.useCallback)((()=>{const e=i.localResultStore.state,r=i.remoteResult.state,o=e&&"reducer"===e.type?e.reducerResults[t]:void 0,n=r&&"reducer"===r.type?r.reducerResults[t]:void 0;return d({reducerId:t,collectionContextStore:i,reducer:f,localReducerResult:o,remoteReducerResult:n})}),[i,f,t]),C=(0,o.useCallback)((()=>{v.current=!1,y()||x(R())}),[R,y]),S=(0,o.useCallback)((()=>{v.current||(v.current=!0,n.default.afterNextFlush(C))}),[C]);return(0,o.useEffect)((()=>(i.remoteResult.addListener(S),i.localResultStore.addListener(S),()=>{i.remoteResult.removeListener(S),i.localResultStore.removeListener(S)})),[i,S]),(0,o.useEffect)((()=>(c.$D({reducerId:t,instanceId:void 0,reducer:f,collectionContextStore:i,groupsPointer:p}),()=>{c.$D({reducerId:t,instanceId:void 0,reducer:void 0,collectionContextStore:i,groupsPointer:p})})),[i,g,p,f,t]),(0,o.useEffect)((()=>{S()}),[]),h}function d(e){const{reducerId:t,localReducerResult:r,remoteReducerResult:o,collectionContextStore:n,reducer:u}=e,l=n.reducers.state,c=n.remoteResult.state;if(n.isClientModeEnabled.state)return r;if("aggregation"===u.type||"groups"===u.type){if(null!=c&&c.reducerResults[t])return c.reducerResults[t];const e=Boolean(c&&"reducer"===c.type&&s.sE(c.reducerResults,((e,t)=>{const r=l[t];return Boolean(r&&"results"===r.reducer.type&&!r.reducer.searchQuery&&"results"===e.type&&e.hasMore&&s.Xy(u.filter,r.reducer.filter))})));return e?r:o}if("results"===u.type){var a;const e=n.wasCreatedThisSession.state,u=Boolean(c&&"reducer"===c.type&&c.reducerResults[t]),l=(0,i.nx)(null===(a=n.collectionViewStore())||void 0===a?void 0:a.getCollectionSource());if((u||e)&&!l&&r&&"results"===r.type){return{...r,hasMore:o&&"results"===o.type?o.hasMore:r.hasMore}}return o}}}}]);