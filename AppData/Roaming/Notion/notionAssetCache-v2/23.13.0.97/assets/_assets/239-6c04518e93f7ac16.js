"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[239],{10239:(e,t,o)=>{o.r(t),o.d(t,{default:()=>it});o(57658);var r=o(67294),n=o(83355),i=o(1302),a=o(15145),s=o(92996),l=o(99036),c=o(80951),d=o(43690),u=o(1800),p=o(77657),g=o(42875),h=o(47453),S=o(59753),y=o(4615),m=o(74446),P=o(21202),f=o(3791),v=o(9291),R=o(36610),C=o(8406),b=o(952),M=o(54642),x=o(893),k=o(47307),_=o(9953),O=o(8055),I=o(82530),w=o(12170);const F=(0,v.defineMessages)({syncedCollectionInputPlaceholder:{defaultMessage:"Link a page",id:"relationPropertyMenuInput.syncedCollection.searchPlaceholder"},connectedRelationInputPlaceholder:{defaultMessage:"Find a page",id:"relationPropertyMenuInput.connectedRelation.searchPlaceholder"},connectedRelationGoogleDriveInputPlaceholder:{defaultMessage:"Paste in Google Drive or Google Docs link",id:"relationPropertyMenuInput.connectedRelationGoogleDrive.searchPlaceholder"},connectedRelationFigmaInputPlaceholder:{defaultMessage:"Paste in https://figma.com/...",id:"relationPropertyMenuInput.connectedRelationFigma.searchPlaceholder"},connectedRelationGithubInputPlaceholder:{defaultMessage:"Paste in https://github.com/...",id:"relationPropertyMenuInput.connectedRelationGithub.searchPlaceholder"}}),T=(0,v.defineMessages)({default:{defaultMessage:"Link or create a page…",id:"relationPropertyMenuInput.placeholder.default"},searchLinkedPages:{defaultMessage:"Search linked pages…",id:"relationPropertyMenuInput.placeholder.searchLinkedPages"},sprint:{defaultMessage:"Search...",id:"relationPropertyMenuInput.placeholder.sprint"}});const j={extensionPoint:"relationPropertyInput",behaviorFnMap:{default:function(e){let{connectedRelationFlags:t,overlayMode:o,disabled:r}=e;const n=function(e){const{isSyncedCollectionRelation:t,isGithubPrRelation:o,isGoogleDriveRelation:r,isFigmaRelation:n,isConnectedRelation:i}=e;if(t)return F.syncedCollectionInputPlaceholder;if(o)return F.connectedRelationGithubInputPlaceholder;if(r)return F.connectedRelationGoogleDriveInputPlaceholder;if(n)return F.connectedRelationFigmaInputPlaceholder;if(i)return F.connectedRelationInputPlaceholder}(t);return t.isConnectedRelation&&n?{inputPlaceholder:n,showTargetDatabase:!1}:{inputPlaceholder:"view"===(null==o?void 0:o.type)||r?T.searchLinkedPages:T.default,showTargetDatabase:!0}},[s.p$]:function(){return{inputPlaceholder:T.sprint,showTargetDatabase:!1}}}};o(21703);var D=o(68626),N=o(91155),L=o(65183),Z=o(77907),U=o(51741);async function V(e){let{environment:t,query:o,targetCollectionStore:r,propertySchema:n,blockPointers:i}=e;try{const e=await Z.deps.searchActions.loader(),{results:a}=await e.searchPagesInCollection({environment:t,query:o.query,collectionId:r.id,limit:o.limit,spaceId:r.getSpaceId(),excludeTemplates:!0,source:"relation_menu",includePublicPagesWithoutExplicitAccess:!0,boostRecentlyViewedPages:!0,ignoresHighlight:!0});return E({results:a,targetCollectionStore:r,propertySchema:n,blockPointers:i})}catch(a){return D.log({level:"error",from:"relationPropertySearchRequest",type:"performDefaultSearchRequest",error:(0,N.Ui)(a)}),[]}}function E(e){let{results:t,targetCollectionStore:o,propertySchema:r,blockPointers:n}=e;const i=new Set(n.map((e=>e.id))),a=[];return t.forEach((e=>{const t={spaceId:o.getSpaceId(),id:e,table:P.iU},n=(0,L.dN)({targetCollectionStore:o,propertySchema:r,pointer:t});if(i.has(e)){const o={key:e,type:U.Rt.SelectedPage,pointer:t};a.push({pageResult:o,canEdit:n})}else{const o={key:e,type:U.Rt.SearchPage,pointer:t};a.push({pageResult:o,canEdit:n})}})),a}const A={relationPropertySearchRequest:{extensionPoint:"relationPropertySearchRequest",behaviorFnMap:{default:V,[s.p$]:async function(e){const{environment:t,query:o,targetCollectionStore:r,propertySchema:n,blockPointers:i}=e;try{const e=await async function(e){const{environment:t,sprintCollectionStore:o,searchQuery:r}=e,n=o.getPropertyMapping(),i=null==n?void 0:n[s.b0.StatusV2],a=null==n?void 0:n[s.b0.Dates];if(!i||!a)throw new Error("Sprints database does not have the required properties");const l="results",c={userTimeZone:(0,g.r)(),searchQuery:r,sort:[{property:i,direction:"ascending"},{property:a,direction:"ascending"}],reducers:{[l]:{type:"results",limit:100}}},d=o.getParentBlockStore();if(!d)return[];await d.load();const u=d.getCollectionViewStores()[0];if(!u)return[];const p=o.getSpaceId(),h=await M.queryCollection(t,{source:{type:"collection",id:o.id,spaceId:p},collectionView:{id:u.id,spaceId:p},loader:c},void 0,{src:"relation_property_menu"});if("success"!==h.type)return[];const S=h.data.result.reducerResults[l];if("results"!==S.type)return[];return S.blockIds}({environment:t,sprintCollectionStore:r,searchQuery:o.query});return E({results:e,targetCollectionStore:r,propertySchema:n,blockPointers:i})}catch(a){D.log({level:"error",from:"relationPropertySearchRequest",type:"performSprintSearchRequest",error:(0,N.Ui)(a)});return await V(e)}}}},relationPropertyInput:j};function B(e){let{extensionPoint:t,appConfigUri:o,behaviorFnArgs:r}=e;const{behaviorFnMap:n}=A[t],i=n.default;if(!o)return i(r);const a=n[o];return a?a(r):i(r)}var q=o(52275),G=o(36488),Q=o(68894),H=o(78140),K=o(53437),W=o(31278),z=o(76798),Y=o(72495),$=o(46247),X=o(9897),J=o(66890),ee=o(23586),te=o(97978),oe=o(70764),re=o(75079),ne=o(33929),ie=o(87279),ae=o(70219),se=o(65598),le=o(29376),ce=o(18514),de=o(18245),ue=o(75822),pe=o(80444),ge=o(77080),he=o(30874),Se=o(79797),ye=o(72087),me=o(88280),Pe=o(30926),fe=o(480),ve=o(86628),Re=o(24405),Ce=o(82990),be=o(74194),Me=o(84076),xe=o(85893);function ke(e){window.__c={n:"RelationPropertyMenuInput"};const{store:t,renderState:o,analyticsFrom:r,inputPlaceholder:n,showTargetDatabase:i,addPage:a}=e,s=(0,fe.O7)(),l=(0,fe.Fy)(),{targetParentUrl:c,targetCollectionStore:d}=o,{menuState:u,menuStore:p}=(0,ve.VK)((()=>({menuState:t.state,menuStore:t})),[t]),{searchQuery:g,searchPopupOpen:h}=(0,ve.VK)((()=>u),[u]),S=(0,ve.VK)((()=>d.getIcon()),[d]),y=(0,Re.yK)((e=>({regular:{color:e.mediumTextColor,whiteSpace:"nowrap",marginLeft:4},headerWrap:{display:"flex",width:"100%",position:"relative",zIndex:2,padding:"6px 10px",fontSize:14,background:e.inputBackground,boxShadow:`\n\t\t\t\t\t0 1px 0 ${e.darkDividerColor}\n\t\t\t\t`},recordTitle:{fontWeight:Ce.Z.fontWeight.semibold,fontSize:14,marginLeft:U.Qi*(l.isRetina?.5:1)},searchIcon:{fill:e.mediumIconColor,width:14,height:14,marginRight:10}})),[l.isRetina]);return(0,xe.jsxs)("div",{style:y.headerWrap,children:[(0,xe.jsx)(be.Z,{style:{flexGrow:1},value:g,placeholder:ne.default.formatMessage(n),forceShowClearButton:Boolean(g||h),focus:!0,onChange:e=>{const t=e.target.value;p.setState({...u,searchQuery:t,searchPopupOpen:!!t,searchLimit:Pe.Z.limitIncrement})},onClearButtonClick:()=>{p.setState(p.getInitialState())},onClick:()=>{p.setState({...u,searchQuery:g,searchPopupOpen:!0,searchLimit:Pe.Z.limitIncrement})},onKeyDown:e=>{"Escape"===e.key&&p.setState(p.getInitialState())},format:be.B.Transparent,onSubmit:()=>{const e=d.getFormat().integration_id,t=he.Z.integrations.state.find((t=>t.id===e)),o=d.getFormat().pattern_name;if(!t||!o)return;(0,le.DB)({integration:t,patternName:o,url:g})&&a()}}),i&&(0,xe.jsx)("div",{style:{display:"flex",marginLeft:10,alignItems:"center"},children:(0,xe.jsx)(v.FormattedMessage,{id:"database.relationProperty.newRelation.targetDatabase",defaultMessage:"<regular>In</regular> {databaseWithIcon}",values:{regular:e=>(0,xe.jsx)("span",{style:y.regular,children:e}),databaseWithIcon:(0,xe.jsxs)(Me.Z,{href:c,style:{marginLeft:U.Qi},innerStyle:{display:"flex"},onClick:()=>{R.ZZ(s,{from:r})},children:[(0,xe.jsx)(W.Z,{disabled:!0,icon:S,isEmptyPage:!1,size:20}),(0,xe.jsx)(z.Z,{store:d,underline:!0,style:y.recordTitle})]})}})})]})}o(30541);var _e=o(72126),Oe=o(60971),Ie=o(14473),we=o(79131),Fe=o(68785),Te=o(32163),je=o(53336),De=o(43145),Ne=o(26388),Le=o(28463),Ze=o(75203),Ue=o(73744),Ve=o(98742),Ee=o(34859),Ae=o(45452),Be=o(29798),qe=o(59674);class Ge extends n.Z{constructor(){super(...arguments),this.storeTypes={menuListStore:Be.Z,draggableListStore:Ae.Z},this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleDraggableListDrop=(e,t)=>et(e,t,this.stores.menuListStore,this.props.onDrag)}didUpdate(e){const{menuListStore:t}=this.stores,{device:o}=this.environment;!this.props.searchQuery||_e.Xy(e.searchQuery,this.props.searchQuery)||o.isMobile||t.setState({...t.state,focus:{section:0,indexLocal:0,indexGlobal:0}})}renderComponent(){const{device:e}=this.environment;return e.isMobile?(0,xe.jsx)(rt,{relationPropertyMenuResultProps:this.props,menuListStore:this.stores.menuListStore,draggableListStore:this.stores.draggableListStore}):(0,xe.jsx)(ot,{relationPropertyMenuResultProps:this.props,menuListStore:this.stores.menuListStore,draggableListStore:this.stores.draggableListStore})}}function Qe(){return(0,xe.jsx)("div",{style:{height:"100%",padding:U.wI,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,xe.jsx)(Fe.Z,{style:{margin:"0 auto"}})})}function He(e){window.__c={n:"RelationSectionHeader"};const{collectionStore:t,targetCollectionStore:o,property:r,showRight:n,disabled:i,style:a}=e,s=(0,ve.VK)((()=>o.isSyncedCollection()),[o]),c=(0,ve.VK)((()=>{const e=t.getSchema()[r];return Boolean(e&&l.NK(e))}),[t,r]);return(0,xe.jsx)(Y.Z,{...e,noTextOverflow:!0,isTitleUppercase:!1,right:n&&!s&&!c&&(0,xe.jsx)(Ze.default,{collectionStore:t,targetCollectionStore:o,property:r,disabled:i}),style:{paddingTop:0,paddingBottom:4,...a},desktopTitleStyle:{height:19,alignItems:"center",marginTop:6,marginBottom:6,paddingLeft:12,paddingRight:9}})}Ge.displayName="RelationPropertyMenuResults",Ge.messages=(0,v.defineMessages)({noEditAccessForUnselectedRelation:{id:"collectionsRelationsPicker.noEditAccessForUnselectedRelation",defaultMessage:"Edit access required to add."},noEditAccessForSelectedRelation:{id:"collectionsRelationsPicker.noEditAccessForSelectedRelation",defaultMessage:"Edit access required to remove."}});const Ke=Ge;function We(e,t){const o=t[e];return Boolean(o&&"relation"===o.type&&1===o.limit)}function ze(e){const{result:t,pointer:o,environment:r,relationPropertyMenuResultProps:n,canDragRow:i,tooltipMessage:a}=e,{disabled:s,parentStore:l,collectionStore:c,targetCollectionStore:d,onAccept:u,property:p,schema:g,blockPropertyValueOverlayStore:h,onClickActionButton:S,handleClearProperty:y}=n,m=Se.G.createChildStore(l,o);return{key:m.id,render:e=>(0,xe.jsx)(Ne.ZP,{disableTooltip:t.canEdit,renderTooltip:()=>ne.default.formatMessage(a),render:n=>(0,xe.jsx)(Z.LazyRelationMenuRow,{...e,canDrag:i,collectionStore:c,targetCollectionStore:d,relatedPageStore:m,disabled:s||!t.canEdit,isSelected:t.pageResult.type===U.Rt.SelectedPage,pageStore:l,property:p,rowType:"popup",onActionButtonClick:()=>S(t.pageResult),blockPropertyValueOverlayStore:h,propertyLimit:We(p,g)?1:void 0,onOpenPageButtonClick:()=>{Ie.O([o],m,r,"relation_property")},handleClearProperty:()=>y(),...(0,Ve.Z)(e,n)}),textWrap:!0}),action:e=>{u(t.pageResult,Ue.DJ(e.event))}}}function Ye(e){const{canDrag:t,property:o,schema:r,totalRelatedPages:n}=e;return t&&!We(o,r)&&n>1}function $e(e){const{numRelatedPages:t,targetCollectionStore:o,property:r,schema:n}=e;if(We(r,n))return(0,xe.jsx)(v.FormattedMessage,{id:"database.relationProperty.relatedPages.limit.subHeader",defaultMessage:"Linked page"});const i=o.getFormat().integration_id;return i===p.f3||i===p.mQ?(0,xe.jsx)(v.FormattedMessage,{id:"database.relationProperty.relatedGoogleDriveOrFigmaFiles.subHeader",defaultMessage:"{count, plural, one {{count} linked file} other {{count} linked files}}",values:{count:t}}):i===p.U9?(0,xe.jsx)(v.FormattedMessage,{id:"database.relationProperty.relatedGithubPages.subHeader",defaultMessage:"{count, plural, one {{count} linked PR} other {{count} linked PRs}}",values:{count:t}}):(0,xe.jsx)(v.FormattedMessage,{id:"database.relationProperty.relatedPages.subHeader",defaultMessage:"{count, plural, one {{count} linked page} other {{count} linked pages}}",values:{count:t}})}function Xe(e){const{loading:t,numRelatedPages:o,numUnrelatedPages:r}=e;if(!t)return 0===r?(0,xe.jsx)(v.FormattedMessage,{id:"database.relationProperty.noResults.subHeader",defaultMessage:"No results"}):0===o?(0,xe.jsx)(v.FormattedMessage,{id:"database.relationProperty.unrelatedPages.subHeader",defaultMessage:"Link a page"}):(0,xe.jsx)(v.FormattedMessage,{id:"database.relationProperty.unrelatedPages.anotherPage.subHeader",defaultMessage:"Link another page"})}function Je(e){const{targetCollectionStore:t,collectionStore:o,property:r,canConfigureCollection:n,numRelatedPages:i,handleClearProperty:a,overlayMode:s,index:l,blockPropertyValueOverlayStore:c}=e;return{key:"backlog",render:e=>(0,xe.jsx)(He,{...e,collectionStore:o,targetCollectionStore:t,property:r,showRight:0===i||"add"===(null==s?void 0:s.type),disabled:!n,style:{paddingBottom:0,paddingTop:0}}),items:[{key:"sprints_backlog",render:e=>(0,xe.jsx)(Le.Z,{focused:e.focused,onMouseEnter:e.onMouseEnter,targetCollectionStore:t,onClick:a,isSection:!1,index:l,blockPropertyValueOverlayStore:c}),action:()=>{a&&a()}}]}}function et(e,t,o,r){r&&r(e),Oe.sv({store:o,focus:{section:0,indexLocal:t.endPosition,indexGlobal:t.endPosition}})}function tt(e){let{relationPropertyMenuResultProps:t,menuListStore:o,draggableListStore:n}=e;window.__c={n:"RowsMenuListComponent"};const{results:i,onDrag:a,parentStore:l,collectionStore:c,targetCollectionStore:d,property:u,canDrag:p,canConfigureCollection:g,loading:h,onCreatePage:S,overlayMode:y,disabled:m,schema:P,searchQuery:f,index:v,handleClearProperty:R,blockPropertyValueOverlayStore:C,relationPropertyMenuStore:b,addPage:M,addingPage:x}=t,k=(0,fe.O7)(),_=(0,r.useCallback)(((e,t)=>et(e,t,o,a)),[o,a]),{device:O}=k,I=(0,ve.VK)((()=>function(e){return e.getDatabaseType()===s.p$?{getCanDragRow:()=>!1,getRelatedSectionHeaderTitle:()=>{},getUnrelatedSectionHeaderTitle:()=>{},getFooterSection:Je}:{getCanDragRow:Ye,getRelatedSectionHeaderTitle:$e,getUnrelatedSectionHeaderTitle:Xe,getFooterSection:()=>{}}}(d)),[d]),w=P[u],F=Boolean("relation"===(null==w?void 0:w.type)&&w.connectedRelation),[T,j]=(0,ve.VK)((()=>{const e=[],o=[],r=i.filter((e=>{let{pageResult:t}=e;return t.type===U.Rt.SelectedPage})).length;for(const n of i)if(n.pageResult.type===U.Rt.SearchPage){Se.G.createChildStore(l,n.pageResult.pointer).isTemplate()||o.push(ze({environment:k,result:n,pointer:n.pageResult.pointer,relationPropertyMenuResultProps:t,canDragRow:!1,tooltipMessage:Ge.messages.noEditAccessForUnselectedRelation}))}else if(n.pageResult.type===U.Rt.SelectedPage){const o=I.getCanDragRow({canDrag:p,property:u,schema:P,totalRelatedPages:r});e.push(ze({environment:k,result:n,pointer:n.pageResult.pointer,relationPropertyMenuResultProps:t,canDragRow:o,tooltipMessage:Ge.messages.noEditAccessForSelectedRelation}))}return[e,o]}),[k,i,l,t,p,P,I,u]),D=I.getRelatedSectionHeaderTitle({numRelatedPages:T.length,targetCollectionStore:d,property:u,schema:P}),N=[];if(T.length>0){const e=T.map((e=>e.key.toString()));N.push({key:"results",render:t=>(0,xe.jsx)(He,{...t,title:D,collectionStore:c,targetCollectionStore:d,property:u,showRight:"add"!==(null==y?void 0:y.type),disabled:!g,style:{paddingBottom:void 0===D?0:4},children:p&&!We(u,P)&&e.length>1?(0,xe.jsx)(we.ZP,{direction:"vertical",keys:e,renderKey:o=>t.children[e.indexOf(o)],onDrop:_,store:n}):t.children}),items:T})}if(!F&&(0===j.length&&0===T.length||j.length>0)){const e=I.getUnrelatedSectionHeaderTitle({loading:h,numRelatedPages:T.length,numUnrelatedPages:j.length}),t=!h&&0===j.length&&!O.isMobile&&!F&&f;let o;t&&j.push({key:"empty",render:e=>(0,xe.jsx)(X.Z,{targetCollectionStore:d,title:f||"",focused:e.focused,onClick:S,isSection:!1,index:v}),action:()=>{S&&S()}}),(t||void 0===e)&&(o={paddingBottom:0});const r={key:"unrelated",render:t=>(0,xe.jsx)(He,{...t,title:e,collectionStore:c,targetCollectionStore:d,property:u,showRight:0===T.length||"add"===(null==y?void 0:y.type),disabled:!g,style:o}),items:j};"add"===(null==y?void 0:y.type)?N.unshift(r):N.push(r)}if(!O.isMobile&&T.length>0&&!m){const e=I.getFooterSection({targetCollectionStore:d,collectionStore:c,property:u,canConfigureCollection:g,numRelatedPages:T.length,handleClearProperty:R,overlayMode:y,index:v,blockPropertyValueOverlayStore:C});e&&N.push(e)}return F?(0,xe.jsx)(qe.c,{blockPropertyValueOverlayStore:C,collectionStore:c,targetCollectionStore:d,sections:N,propertySchema:w,property:u,pageRecordStore:l,search:f,relationPropertyMenuStore:b,addPage:M,addingPage:x}):(0,xe.jsx)(Te.Z,{type:Te.i.Vertical,store:o,style:{padding:"4px 0px"},initialFocus:k.device.isMobile?void 0:0,sections:N})}function ot(e){let{relationPropertyMenuResultProps:t,menuListStore:o,draggableListStore:n}=e;const{results:i,loading:a,onScrollOffsetChange:s}=t,l=0===i.length;return(0,xe.jsx)(r.Fragment,{children:(0,xe.jsxs)(je.Z,{style:{width:"100%",maxHeight:300,position:"relative",...l&&{marginTop:0}},type:Ee.Z.Y,children:[(0,xe.jsx)(tt,{relationPropertyMenuResultProps:t,menuListStore:o,draggableListStore:n}),a&&(0,xe.jsx)(Qe,{}),s&&(0,xe.jsx)(De.Z,{onChange:s})]})})}function rt(e){let{relationPropertyMenuResultProps:t,menuListStore:o,draggableListStore:n}=e;const{results:i,loading:a,resultsType:s,schema:l,property:c,blockPropertyValueOverlayStore:d,collectionStore:u,targetCollectionStore:p,parentStore:g,searchQuery:h,relationPropertyMenuStore:S,addPage:y,addingPage:m}=t,P=0===i.length,f=l[c];return Boolean("relation"===(null==f?void 0:f.type)&&f.connectedRelation)&&P?(0,xe.jsx)("div",{style:{marginTop:20},children:(0,xe.jsx)(qe.c,{blockPropertyValueOverlayStore:d,collectionStore:u,targetCollectionStore:p,sections:[],propertySchema:f,property:c,pageRecordStore:g,search:h,relationPropertyMenuStore:S,addPage:y,addingPage:m})}):(0,xe.jsxs)(r.Fragment,{children:[P&&!a&&"existing"===s?void 0:(0,xe.jsx)(tt,{relationPropertyMenuResultProps:t,menuListStore:o,draggableListStore:n}),a&&(0,xe.jsx)(Qe,{})]})}class nt extends n.Z{constructor(){super(...arguments),this.storeTypes={store:Pe.Z,requestStore:ye.Z},this.maybeOverwriteBaseUrlFromSpaceId=(0,ae.b)(this.environment),this.isMemberOfSpace=this.createComputedStore((()=>{var e;return null===(e=pe.default.state.currentSpaceStore)||void 0===e?void 0:e.canEdit()})),this.addPage=async e=>{const{collectionStore:t,blockPropertyValueOverlayStore:o,blockStore:r,schema:n,property:i}=this.props,a=this.getRenderState();if(!a)return;const{targetCollectionStore:s}=a,l=s.getFormat().integration_id,d=he.Z.externalAuthentications.state.filter((e=>e.integration_id===l))[0],u=s.getFormat().pattern_name,g=he.Z.integrations.state.find((e=>e.id===l)),{searchQuery:h}=this.stores.store.state,S=(0,se.OY)(r)?r:void 0,y=(0,se.OY)(r)?r.getPropertyStore(i):void 0;this.stores.store.setState({...this.stores.store.state,addingPage:!0});try{var m,R;if(!(t&&g&&S&&y))return;const r=c.rq(y.getValue()),a=e||h||"";if(!(0,le.DB)({integration:g,patternName:u,url:a}))return void k.showDialog({items:[{label:(0,xe.jsx)(v.FormattedMessage,{id:"connectedRelationPropertyMenuResults.unsupportedUrlErrorDialog.copyDebuggingInformation",defaultMessage:"Copy debugging information"}),color:"blue",onAccept:()=>{x.RD({environment:this.environment,stringValue:JSON.stringify({botId:null==d?void 0:d.parent_id,url:a},null,2),copiedMessage:x.tq.copiedToClipboard})}},{label:(0,xe.jsx)(v.FormattedMessage,{id:"connectedRelationPropertyMenuResults.unsupportedUrlErrorDialog.closeButton",defaultMessage:"Close"}),onAccept:()=>{}}],showCancel:!1,keepFocus:!1,message:(0,xe.jsx)(v.FormattedMessage,{id:"connectedRelationPropertyMenuResults.unsupportedUrlErrorDialog.title",defaultMessage:"This source is currently not supported. Please try a different source."})});const l=n[i],O=c.Kp(l),F=O?y.id:void 0,T=c.gg(l),j=c.ic(l),D=c.U8(l),N=c.yF(l),L=j&&ge.default.checkGate("figma_connected_relation"),Z=D&&ge.default.checkGate("zendesk_connected_relation"),U=N&&ge.default.checkGate("cron_connected_relation"),V=D&&ge.default.checkGate("zendesk_ai_enabled"),E=T&&ge.default.checkGate("google_drive_connected_relation"),A=(0,oe.NP)(g.id),B=(null==g?void 0:g.id)===p.U9?null===(m=A[0])||void 0===m?void 0:m.id:null==d?void 0:d.parent_id,q=O||E||Z||U||L?A.map((e=>e.id)):[B],G=await w.yp({environment:this.environment,url:a,botIds:q,userDefinedExternalCollectionStore:s,relatedPageId:F});if(!G)return;const Q=(null===(R=me.subscriptionDataStoreInstance.state)||void 0===R?void 0:R.addOns)??[];if(V&&(0,f.de)(Q)){const e=this.environment;M.getZendeskTicketConversation(e,{ticketUrl:a,spaceId:G.getSpaceId(),botId:q[0],pageId:y.id}),te.j(e,"zendesk_unfurl_ai")}I.createAndCommit({userAction:"connectedRelationPropertyMenuResults.createRelationPage",environment:this.environment,perform:e=>{const t={id:G.id,table:P.iU,spaceId:G.getSpaceId()},n=null!=l&&l.limit?[t]:[...r,t],a=c.ow(n);_.sO({store:y,value:a,transaction:e}),o&&o.state.isOpen&&o.state.collectionContextStore&&(C.rv({environment:this.environment,collectionContextStore:o.state.collectionContextStore,block_id:S.id,property:i,property_type:"relation",from:"relation_section",isFromBulkActionsToolbar:!1,integration_id:g.id,action:"add"}),b.W(this.environment,{...(0,re.Pn)(o.state.collectionContextStore),from:"relation_menu",type:"page",integration_id:g.id,creating_block_id:S.id}))}}),this.stores.store.reset()}finally{this.stores.store.setState({...this.stores.store.state,addingPage:!1})}},this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleSearchInputChange=e=>function(e,t){const o=e.target.value;t.setState({...t.state,searchQuery:o,searchLimit:Pe.Z.limitIncrement})}(e,this.stores.store),this.handleMobileTargetCollectionClick=()=>{const e=this.getRenderState();e&&(O.c4({environment:this.environment,url:e.targetParentUrl}),R.ZZ(this.environment,{from:this.props.analyticsFrom}))},this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleMobileSearchInputClick=()=>function(e){const t=e.state;e.setState({...e.state,searchQuery:t.searchQuery,searchPopupOpen:!0,searchLimit:Pe.Z.limitIncrement})}(this.stores.store),this.handleSelectedPageClick=(e,t)=>{const{mainEditorCurrentBlockStore:o}=pe.default.state;if(!o)return;let r;if(t){const t=Se.G.createChildStore(o,e.pointer),n=t.isDefined()?this.maybeOverwriteBaseUrlFromSpaceId(t.getSpaceId()):void 0;r=(0,u.Z)({pageId:e.pointer.id,pageModel:t.getModel(),baseUrl:n,pageVisitSource:a.tY.LinkInPage})}else{const t=o.isDefined()?this.maybeOverwriteBaseUrlFromSpaceId(o.getSpaceId()):void 0;r=(0,u.Z)({pageId:o.id,pageModel:o.getModel(),baseUrl:t,peekViewBlockId:e.pointer.id,pageVisitSource:a.tY.LinkInPage})}O.c4({environment:this.environment,url:r,openInNew:t}),R.XX(this.environment,{from:this.props.analyticsFrom,meta_click:Boolean(t)})},this.handleValueRelationPropertyMenuResultsAccept=(e,t)=>{e.type===U.Rt.SelectedPage&&this.handleSelectedPageClick(e,t)},this.handleSearchRelationPropertyMenuResultsAccept=(e,t)=>{var o;if(this.props.disabled)return;const{value:r,onChange:n,overlayMode:i}=this.props,{mainEditorCurrentBlockStore:a}=pe.default.state;if(!a)return;const s=null===(o=this.getRenderState())||void 0===o?void 0:o.propertySchema.limit;if(e.type===U.Rt.SearchPage){var l,c,d,u;n({value:s?[e.pointer]:"add"===(null==i?void 0:i.type)?[...r.slice(0,i.index),e.pointer,...r.slice(i.index)]:[...r,e.pointer]}),R.dw(this.environment,{from:this.props.analyticsFrom,collection_id:null===(l=this.props.collectionStore)||void 0===l?void 0:l.id,collection_view_id:null===(c=this.context.collectionContextStore)||void 0===c||null===(c=c.collectionViewStore())||void 0===c?void 0:c.id,collection_view_block_id:null===(d=this.context.collectionContextStore)||void 0===d||null===(d=d.collectionViewBlockStore())||void 0===d?void 0:d.id,target_collection_id:null===(u=this.getRenderState())||void 0===u||null===(u=u.targetCollectionStore)||void 0===u?void 0:u.id})}else e.type===U.Rt.SelectedPage&&this.handleSelectedPageClick(e,t)},this.handleCreateNewPage=e=>{var t,o,r;const{searchQuery:n}=this.stores.store.state,i=(0,y.ZP)(),a=null===(t=this.getRenderState())||void 0===t?void 0:t.targetCollectionStore.getSpaceId(),{value:s,onChange:l}=this.props,c=null===(o=this.getRenderState())||void 0===o?void 0:o.propertySchema.limit,d={id:i,table:P.iU,spaceId:a};l({newPage:{id:i,spaceId:a,name:n},value:c?[d]:e?[...s.slice(0,e),d,...s.slice(e)]:[...s,d]}),b.W(this.environment,{...(0,re.Pn)(this.context.collectionContextStore),from:"relation_menu",type:"page",target_collection_id:null===(r=this.getRenderState())||void 0===r||null===(r=r.targetCollectionStore)||void 0===r?void 0:r.id,new_page_id:i,creating_block_id:i})},this.handleClickActionButton=e=>{var t;const{value:o,onChange:r,overlayMode:n}=this.props,{mainEditorCurrentBlockStore:i}=pe.default.state;if(!i)return;const a=null===(t=this.getRenderState())||void 0===t?void 0:t.propertySchema.limit;if(e.type===U.Rt.SearchPage){var s;r({value:a?[e.pointer]:"add"===(null==n?void 0:n.type)?[...o.slice(0,n.index),e.pointer,...o.slice(n.index)]:[...o,e.pointer]}),R.dw(this.environment,{from:this.props.analyticsFrom,...(0,re.Pn)(this.context.collectionContextStore),target_collection_id:null===(s=this.getRenderState())||void 0===s||null===(s=s.targetCollectionStore)||void 0===s?void 0:s.id})}else if(e.type===U.Rt.SelectedPage){var l;r({value:a?[]:o.filter((t=>t.id!==e.pointer.id))}),R.WF(this.environment,{...(0,re.Pn)(this.context.collectionContextStore),from:this.props.analyticsFrom,target_collection_id:null===(l=this.getRenderState())||void 0===l||null===(l=l.targetCollectionStore)||void 0===l?void 0:l.id})}var c;a&&(null===(c=this.props.blockPropertyValueOverlayStore)||void 0===c||c.setState({isOpen:!1}))},this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleMobileSearchMenuClickRight=()=>{!function(e){e.reset()}(this.stores.store)},this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleSearchScrollOffsetChange=e=>function(e,t,o){const{loading:r,result:n}=o.state;e<Pe.Z.incrementScrollOffset&&n&&!r&&n.results.length>=t.state.searchLimit&&t.setState({...t.state,searchLimit:t.state.searchLimit+Pe.Z.limitIncrement})}(e,this.stores.store,this.stores.requestStore),this.performSearchRequest=async e=>{const{disabled:t}=this.props,o=this.getRenderState();if(!o)return[];if(t)return[];if(c.gg(o.propertySchema)||c.ic(o.propertySchema))return[];const{targetCollectionStore:r,propertySchema:n}=o;return await B({extensionPoint:"relationPropertySearchRequest",appConfigUri:r.getDatabaseType(),behaviorFnArgs:{environment:this.environment,query:e,targetCollectionStore:r,propertySchema:n,blockPointers:this.props.value}})},this.getRecordModel=S.om.fromMonomorphicFunctionUnsafe((e=>Se.G.createChildStore(this.props.blockStore,e).getRecordModel(e)),m.mF.fromMonomorphicFunctionUnsafe((e=>{const t=Se.G.createChildStore(this.props.blockStore,e);return t.computeWithRecordValues((e=>{let{getRecordValueAndSubscribe:o}=e;return o(t)}))})))}didMount(){super.didMount(),i.default.afterNextFlush((()=>{i.default.afterNextFlush((()=>{const e=this.getRenderState();if(e){0===this.getValueResults(e).length&&this.stores.store.setState({searchPopupOpen:this.environment.device.isMobile,searchQuery:this.props.insertChar??"",searchLimit:Pe.Z.limitIncrement,addingPage:!1})}}))}))}renderComponent(){const{device:e}=this.environment,t=this.getRenderState();if(t)return(0,xe.jsx)(G.Z,{capture:!0,allowMenuList:!0,allowEsc:!0,allowUndo:!0,allowTabUntab:!0,render:()=>e.isMobile?this.renderMobileMenu(t):this.renderDesktopMenu(t)})}renderDesktopMenu(e){const{searchQuery:t}=this.stores.store.state,o=this.stores.requestStore.state.result,{disabled:r,analyticsFrom:n,overlayMode:i}=this.props,{targetCollectionStore:a,connectedRelationFlags:s}=e,{isGithubPrRelation:l,isGoogleDriveRelation:c,isFigmaRelation:d,isZendeskRelation:u}=s,g=Boolean(he.Z.bots.state.find((e=>e.integration_id===p.U9))),h=l&&!g||(c||d||u)&&!this.isMemberOfSpace.state,S=i&&"add"===i.type?i.index:void 0,{inputPlaceholder:y,showTargetDatabase:m}=B({appConfigUri:a.getDatabaseType(),behaviorFnArgs:{connectedRelationFlags:s,overlayMode:i,disabled:r},extensionPoint:"relationPropertyInput"});return(0,xe.jsx)(H.Z,{menuType:ie.og.Popup,header:h?null:(0,xe.jsx)(ke,{store:this.stores.store,renderState:e,inputPlaceholder:y,showTargetDatabase:m,analyticsFrom:n,addPage:this.addPage}),footer:this.renderFooter({requestStateResult:o,searchQuery:t,overlayMode:i,disabled:r,targetCollectionStore:a,index:S,propertySchema:e.propertySchema}),children:(0,xe.jsx)("div",{style:{overflow:"hidden",maxHeight:"70vh"},children:this.renderSearchResults(e)})})}renderFooter(e){const{requestStateResult:t,searchQuery:o,overlayMode:r,disabled:n,targetCollectionStore:i,index:a,propertySchema:l}=e;return!(i.getFormatStore().getKeyStore("app_config_uri").getValue()===s.p$)&&"view"===(null==r?void 0:r.type)||n||l.connectedRelation?null:t&&t.results.length>0&&o&&(0,xe.jsx)(X.Z,{targetCollectionStore:i,title:o,onClick:this.handleCreateNewPage,focused:!1,isSection:!0,index:a})}renderMobileMenu(e){const{device:t}=this.environment,{searchPopupOpen:o}=this.stores.store.state,{collectionStore:r,property:n,schema:i,blockStore:a,blockPropertyValueOverlayStore:s,disabled:l,canConfigureCollection:c,onDismiss:d}=this.props,{targetCollectionStore:u,connectedRelationFlags:{isGithubPrRelation:g,isGoogleDriveRelation:S,isFigmaRelation:y,isConnectedRelation:m}}=e,{mediumTextColor:P}=this.theme,f=this.getValueResults(e),R=Boolean(he.Z.bots.state.find((e=>e.integration_id===p.U9))),C=Boolean(he.Z.bots.state.find((e=>e.integration_id===p.f3))),b=Boolean(he.Z.bots.state.find((e=>e.integration_id===p.mQ))),M=g&&!R||S&&!C||y&&!b;return(0,xe.jsxs)(H.Z,{menuType:ie.og.Modal,title:e.propertySchema.name,right:(0,xe.jsx)(v.FormattedMessage,{defaultMessage:"Done",id:"relationPropertyMenu.mobileMenuDone.button"}),onClickRight:d,children:[m?null:(0,xe.jsx)(Y.Z,{disableMobilePadding:!0,children:(0,xe.jsx)(q.Z,{focused:!1,title:(0,xe.jsx)("div",{style:{display:"flex"},children:(0,xe.jsx)(v.FormattedMessage,{id:"database.relationProperty.newRelation.targetDatabase",defaultMessage:"<regular>In</regular> {databaseWithIcon}",values:{regular:e=>e,databaseWithIcon:(0,xe.jsxs)("div",{style:{display:"flex",marginLeft:2*U.Qi},children:[(0,xe.jsx)(W.Z,{disabled:!0,icon:u.getIcon(),isEmptyPage:!1,size:20}),(0,xe.jsx)(z.Z,{store:u,underline:!0,style:{marginLeft:U.Qi}})]})}})}),showExtensionArrow:!1,onClick:this.handleMobileTargetCollectionClick})}),M?null:(0,xe.jsx)(Y.Z,{topBorder:!0,disableMobilePadding:!1,children:(0,xe.jsx)(K.GI,{popupType:K.kQ.SlideUp,open:o,origin:(0,xe.jsx)(q.Z,{focused:!1,title:(0,xe.jsxs)("span",{style:{display:"flex",alignItems:"center"},children:[(0,h.R)({marginRight:8,width:t.isMobile?16:14,height:t.isMobile?16:14}),(0,xe.jsx)(v.FormattedMessage,{defaultMessage:"Add a page",id:"relationPropertyMenu.addAPage.button"})]}),onClick:this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleMobileSearchInputClick,style:{color:P}}),render:()=>this.renderSearchResults(e)})}),(0,xe.jsx)(Ke,{collectionStore:r,targetCollectionStore:u,results:f,resultsType:"existing",property:n,schema:i,parentStore:a,disabled:l,canConfigureCollection:c,loading:!1,canDrag:!1,blockPropertyValueOverlayStore:s,onAccept:this.handleValueRelationPropertyMenuResultsAccept,onClickActionButton:this.handleClickActionButton,onCreatePage:this.handleCreateNewPage,handleClearProperty:()=>st(this.props.onChange),relationPropertyMenuStore:this.stores.store,addPage:this.addPage,addingPage:this.stores.store.state.addingPage})]})}renderSearchResults(e){const{device:t}=this.environment,{collectionStore:o,value:r,property:n,schema:i,blockStore:a,blockPropertyValueOverlayStore:s,disabled:l,canConfigureCollection:c,overlayMode:u}=this.props,{requestStore:p}=this.stores,{targetCollectionStore:h,propertySchema:S}=e,{searchQuery:y,searchLimit:m}=this.stores.store.state;let f=de.default.mark("rum.relation_search_query");const C=S.limit?r.slice(0,1):r,b={request:{query:y,limit:m},debounce:ue.vp,performRequest:async e=>({results:await this.performSearchRequest(e),query:e.query}),render:(r,p)=>{let S=[];S=y?this.getValueResults(e).filter((e=>{let{pageResult:t}=e;const o=Se.G.createChildStore(this.props.blockStore,t.pointer),r=o.getModel();if(r)return(0,d.fY)({block:r,query:y,getRecordModel:o.getRecordModel,userTimeZone:(0,g.r)(),schema:i,intl:ne.default.getIntl(),onlyPropertyIds:["title"]})})):this.getValueResults(e);const m=!p&&0===S.length,b=S;p&&p.results.forEach((e=>{const t=e.pageResult;if((t.type===U.Rt.SelectedPage||t.type===U.Rt.SearchPage)&&S.find((e=>(e.pageResult.type===U.Rt.SelectedPage||e.pageResult.type===U.Rt.SearchPage)&&e.pageResult.pointer.id===t.pointer.id)))return;const o=e.pageResult.type!==U.Rt.NewPage?C.map((e=>e.id)).includes(e.pageResult.pointer.id):void 0;o&&!y&&"add"===(null==u?void 0:u.type)||(e.pageResult.type===U.Rt.SearchPage&&o?b.push({...e,pageResult:{...e.pageResult,type:U.Rt.SelectedPage}}):e.pageResult.type!==U.Rt.SelectedPage||o?b.push(e):b.push({...e,pageResult:{...e.pageResult,type:U.Rt.SearchPage}}))})),!m&&""!==y&&f&&p&&p.query===y&&(de.default.measure(f,{environment:this.environment}),f=void 0);const M=(0,xe.jsx)(Ke,{collectionStore:o,targetCollectionStore:h,results:b,resultsType:0===b.length&&0===this.getValueResults(e).length?"existing":"search",property:n,schema:i,parentStore:a,disabled:l,canConfigureCollection:c,loading:m,canDrag:!l&&0===y.length,blockPropertyValueOverlayStore:s,onAccept:this.handleSearchRelationPropertyMenuResultsAccept,onClickActionButton:this.handleClickActionButton,onScrollOffsetChange:this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleSearchScrollOffsetChange,onDrag:e=>function(e,t,o,r,n){o({value:e.map((e=>({id:e,spaceId:t.pointer.spaceId,table:P.iU})))}),R.yT(n,{from:r})}(e,this.props.collectionStore,this.props.onChange,this.props.analyticsFrom,this.environment),onCreatePage:this.handleCreateNewPage,handleClearProperty:()=>st(this.props.onChange),searchQuery:y,overlayMode:u,relationPropertyMenuStore:this.stores.store,addPage:this.addPage,addingPage:this.stores.store.state.addingPage});if(t.isMobile){const{connectedRelationFlags:o}=e,{inputPlaceholder:r}=B({appConfigUri:void 0,behaviorFnArgs:{connectedRelationFlags:o,overlayMode:u,disabled:l},extensionPoint:"relationPropertyInput"});return(0,xe.jsx)(H.Z,{menuType:ie.og.Modal,title:(0,xe.jsx)(v.FormattedMessage,{defaultMessage:"Relation",id:"relationPropertyMenu.mobileRelationMenu.title"}),left:(0,xe.jsx)(at,{}),right:(0,xe.jsx)(v.FormattedMessage,{defaultMessage:"Done",id:"relationPropertyMenu.mobileDoneButton"}),header:(0,xe.jsxs)(xe.Fragment,{children:[(0,xe.jsx)(Q.ZP,{value:y,disabled:l,onChange:this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleSearchInputChange,placeholder:ne.default.formatMessage(r),showClearButton:!0,focus:!t.isMobile||void 0,focusInitial:!0,style:{...t.isAndroid&&{borderBottom:"none"}}}),y&&!l&&!o.isConnectedRelation&&(0,xe.jsx)(X.Z,{targetCollectionStore:h,title:y,onClick:this.handleCreateNewPage,focused:!1,isSection:!0})]}),onClickRight:this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleMobileSearchMenuClickRight,children:M})}return M}};return(0,xe.jsx)(ee.Z,{...b,requestStore:p})}getRenderState(){const{schema:e,property:t,blockStore:o,collectionStore:r}=this.props,n=e[t];if(!n||"relation"!==n.type)return;const i=l.j0(n);if(!i)return;const a=Se.NW.createChildStore(o,i),s=a.getParentId();if(!s)return;const c=Se.G.createChildStore(a,{table:P.iU,id:s}),d=l.oC({id:a.id,schema:a.getSchema(),format:a.getFormat(),space_id:a.getSpaceId()}),p=c.isDefined()?this.maybeOverwriteBaseUrlFromSpaceId(c.getSpaceId()):void 0,g=(0,u.Z)({pageId:c.id,pageModel:c.getModel(),baseUrl:p,pageVisitSource:void 0});return{propertySchema:n,property:t,targetCollectionStore:a,targetParentBlock:c,targetCollectionSchema:d,targetParentUrl:g,collectionStore:r,connectedRelationFlags:lt({targetCollectionStore:a,propertySchema:n})}}getValueResults(e){const{value:t,overlayMode:o}=this.props,{propertySchema:r,targetCollectionStore:n}=e,{searchQuery:i}=this.stores.store.state;return i||"add"!==(null==o?void 0:o.type)?c.j$({relationValue:t,propertySchema:r,getRecordModel:this.getRecordModel}).map((e=>({pageResult:{key:e.id,type:U.Rt.SelectedPage,pointer:e},canEdit:(0,L.dN)({targetCollectionStore:n,propertySchema:r,pointer:e})}))):[]}}nt.displayName="RelationPropertyMenu",nt.contextTypes={...n.w,...J.xm};const it=nt;function at(){return(0,xe.jsx)($.Z,{href:(0,ce.UY)("guides.relations"),analyticsFrom:"relation_menu"})}function st(e){e({value:[]})}function lt(e){const{targetCollectionStore:t,propertySchema:o}=e;return{isSyncedCollectionRelation:t.isSyncedCollection(),isGithubPrRelation:c.Kp(o),isGoogleDriveRelation:c.gg(o),isFigmaRelation:c.ic(o),isZendeskRelation:c.U8(o),isConnectedRelation:l.NK(o)}}}}]);